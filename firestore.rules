/**
 * This ruleset enforces a collaborative, family-centric security model for a
 * personal finance application.
 *
 * Core Philosophy:
 * Access to data is controlled at the "family" level. A user can only access
 * financial records (incomes, expenses) if they are a member of the family
 * associated with that data. All operations require user authentication.
 *
 * Data Structure:
 * The data is organized hierarchically. A top-level 'families' collection
 * holds documents for each family unit. Each family document then contains
 * 'incomes' and 'expenses' subcollections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user is a member of the specified family.
     * This is the primary authorization check for all read/write operations.
     * It relies on a `members` array being denormalized on the family document.
     */
    function isFamilyMember(familyId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.members;
    }

    /**
     * Validates that the user is creating a family and is including themselves
     * as one of the initial members. Also enforces relational integrity.
     */
    function isCreatingOwnFamily() {
      return isSignedIn()
        && request.auth.uid in request.resource.data.members;
    }
    
    /**
     * Validates incoming data for a new income document, ensuring the
     * denormalized familyId matches the document's path.
     */
    function hasValidIncomeData(familyId) {
      return request.resource.data.familyId == familyId;
    }

    /**
     * Validates incoming data for a new expense document, ensuring the
     * denormalized familyId matches the document's path.
     */
    function hasValidExpenseData(familyId) {
      return request.resource.data.familyId == familyId;
    }

    /**
     * Ensures critical relational fields on an existing income document cannot
     * be changed after creation.
     */
    function hasImmutableIncomeFields() {
      return request.resource.data.familyId == resource.data.familyId;
    }

    /**
     * Ensures critical relational fields on an existing expense document cannot
     * be changed after creation.
     */
    function hasImmutableExpenseFields() {
      return request.resource.data.familyId == resource.data.familyId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to Family documents.
     * @path /families/{familyId}
     * @allow (get) A user can read a family document if their UID is in the `members` array.
     * @allow (create) An authenticated user can create a family if they include their own UID in the `members` array.
     * @deny (list) Users cannot list all families in the database.
     * @deny (update) A user who is not in the `members` array cannot update the family.
     * @principle Enforces collaborative ownership based on a denormalized `members` list.
     */
    match /families/{familyId} {
      allow get: if isFamilyMember(familyId);
      allow list: if false;
      allow create: if isCreatingOwnFamily();
      allow update: if isFamilyMember(familyId) && resource != null;
      allow delete: if isFamilyMember(familyId) && resource != null;
    }

    /**
     * @description Controls access to a family's income records.
     * @path /families/{familyId}/incomes/{incomeId}
     * @allow (get, list) A member of a family can read and list all income records for that family.
     * @allow (create) A family member can create a new income record for their family.
     * @deny (create) A user cannot create an income record for a family they do not belong to.
     * @deny (update) A user cannot update an income record for a family they do not belong to.
     * @principle Inherits access control from the parent family document to protect child data.
     */
    match /families/{familyId}/incomes/{incomeId} {
      allow get: if isFamilyMember(familyId);
      allow list: if isFamilyMember(familyId);
      allow create: if isFamilyMember(familyId) && hasValidIncomeData(familyId);
      allow update: if isFamilyMember(familyId) && resource != null && hasImmutableIncomeFields();
      allow delete: if isFamilyMember(familyId) && resource != null;
    }

    /**
     * @description Controls access to a family's expense records.
     * @path /families/{familyId}/expenses/{expenseId}
     * @allow (get, list) A member of a family can read and list all expense records for that family.
     * @allow (create) A family member can create a new expense record for their family.
     * @deny (create) A user cannot create an expense record for a family they do not belong to.
     * @deny (update) A user cannot update an expense record for a family they do not belong to.
     * @principle Inherits access control from the parent family document to protect child data.
     */
    match /families/{familyId}/expenses/{expenseId} {
      allow get: if isFamilyMember(familyId);
      allow list: if isFamilyMember(familyId);
      allow create: if isFamilyMember(familyId) && hasValidExpenseData(familyId);
      allow update: if isFamilyMember(familyId) && resource != null && hasImmutableExpenseFields();
      allow delete: if isFamilyMember(familyId) && resource != null;
    }

    match /taskMonths/{monthId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    match /refunds/{refundId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

     match /hourLogs/{logId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    match /attendanceSessions/{sessionId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }
}