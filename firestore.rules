/**
 * @file Firestore Security Rules for Family Financials App
 * @core_philosophy This ruleset enforces a strict user-ownership model, where each user can only access their own data.
 * @data_structure All data is nested under /users/{userId}, with subcollections for incomes and expenses. This structure ensures clear ownership and simplifies security rules.
 * @key_security_decisions User listing is disallowed.  All write operations require the user to be authenticated and to own the data being modified.
 * @denormalization_for_authorization The 'userId' field is present on all Income and Expense documents, allowing for simple ownership checks without additional reads.
 * @structural_segregation N/A - All data is private to the user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to create, read, update, and delete their own user document.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create a document where document ID matches their UID.
     * @allow (get) User with UID 'user_abc' can read their own user document.
     * @allow (update) User with UID 'user_abc' can update their own user document.
     * @allow (delete) User with UID 'user_abc' can delete their own user document.
     * @deny (create) User with UID 'user_def' cannot create a document with ID 'user_abc'.
     * @deny (get) User with UID 'user_def' cannot read user document of 'user_abc'.
     * @deny (update) User with UID 'user_def' cannot update user document of 'user_abc'.
     * @deny (delete) User with UID 'user_def' cannot delete user document of 'user_abc'.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows a user to create, read, update, and delete their own income records.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) User with UID 'user_abc' can create an income document under their user path with userId 'user_abc'.
     * @allow (get) User with UID 'user_abc' can read an income document under their user path.
     * @allow (update) User with UID 'user_abc' can update an income document under their user path.
     * @allow (delete) User with UID 'user_abc' can delete an income document under their user path.
     * @deny (create) User with UID 'user_def' cannot create an income document under the user path of 'user_abc'.
     * @deny (get) User with UID 'user_def' cannot read an income document under the user path of 'user_abc'.
     * @deny (update) User with UID 'user_def' cannot update an income document under the user path of 'user_abc'.
     * @deny (delete) User with UID 'user_def' cannot delete an income document under the user path of 'user_abc'.
     * @principle Enforces document ownership for all operations on income records.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows a user to create, read, update, and delete their own expense records.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with UID 'user_abc' can create an expense document under their user path with userId 'user_abc'.
     * @allow (get) User with UID 'user_abc' can read an expense document under their user path.
     * @allow (update) User with UID 'user_abc' can update an expense document under their user path.
     * @allow (delete) User with UID 'user_abc' can delete an expense document under their user path.
     * @deny (create) User with UID 'user_def' cannot create an expense document under the user path of 'user_abc'.
     * @deny (get) User with UID 'user_def' cannot read an expense document under the user path of 'user_abc'.
     * @deny (update) User with UID 'user_def' cannot update an expense document under the user path of 'user_abc'.
     * @deny (delete) User with UID 'user_def' cannot delete an expense document under the user path of 'user_abc'.
     * @principle Enforces document ownership for all operations on expense records.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}