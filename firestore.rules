/**
 * @fileoverview Firestore Security Rules for the financial management application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict family-ownership model. Each family has its own
 * data tree, and only authenticated users can access data within their own family.
 *
 * Data Structure:
 * - /families/{familyId}: Stores family profiles. Only authenticated users can
 *   create, read, update, or delete their own family profile.
 * - /families/{familyId}/incomes/{incomeId}: Stores income records for a
 *   specific family. Only members of the parent family can manage income records.
 * - /families/{familyId}/expenses/{expenseId}: Stores expense records for a
 *   specific family. Only members of the parent family can manage expense records.
 *
 * Key Security Decisions:
 * - All write operations require authentication (`request.auth != null`).
 * - Only the owner of a family can read, update, or delete it.
 * - Income and expenses are secured by path-based ownership.
 *
 * Denormalization for Authorization:
 * The `familyId` is included within the `Income` and `Expense` documents to
 * allow for easy enforcement of path-based ownership. This avoids the need to
 * perform expensive `get()` operations to verify the parent family.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to family profiles.
     * @path /families/{familyId}
     * @allow (create) User with auth UID 'user_abc' can create a family document with ID 'user_abc'.
     * @deny (create) User with auth UID 'user_xyz' cannot create a family document with ID 'user_abc'.
     * @allow (get) User with auth UID 'user_abc' can read a family document with ID 'user_abc'.
     * @deny (get) User with auth UID 'user_xyz' cannot read a family document with ID 'user_abc'.
     * @allow (update) User with auth UID 'user_abc' can update a family document with ID 'user_abc'.
     * @deny (update) User with auth UID 'user_xyz' cannot update a family document with ID 'user_abc'.
     * @allow (delete) User with auth UID 'user_abc' can delete a family document with ID 'user_abc'.
     * @deny (delete) User with auth UID 'user_xyz' cannot delete a family document with ID 'user_abc'.
     * @principle Enforces document ownership for all operations on family profiles.
     */
    match /families/{familyId} {
      // Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Function to check if the user is the owner of the family
      function isOwner(familyId) {
        return isSignedIn() && request.auth.uid == familyId;
      }

      // Function to check if the user is the owner of the family and the resource exists
      function isExistingOwner(familyId) {
        return isOwner(familyId) && resource != null;
      }

      allow get: if isOwner(familyId);
      allow list: if false; // Listing families is not allowed.
      allow create: if isOwner(familyId);
      allow update: if isExistingOwner(familyId);
      allow delete: if isExistingOwner(familyId);
    }

    /**
     * @description Manages access to income records within a specific family.
     * @path /families/{familyId}/incomes/{incomeId}
     * @allow (create) User with auth UID 'user_abc' can create an income document in family 'user_abc'.
     * @deny (create) User with auth UID 'user_xyz' cannot create an income document in family 'user_abc'.
     * @allow (get) User with auth UID 'user_abc' can read an income document in family 'user_abc'.
     * @deny (get) User with auth UID 'user_xyz' cannot read an income document in family 'user_abc'.
     * @allow (update) User with auth UID 'user_abc' can update an income document in family 'user_abc'.
     * @deny (update) User with auth UID 'user_xyz' cannot update an income document in family 'user_abc'.
     * @allow (delete) User with auth UID 'user_abc' can delete an income document in family 'user_abc'.
     * @deny (delete) User with auth UID 'user_xyz' cannot delete an income document in family 'user_abc'.
     * @principle Enforces path-based ownership for income records.
     */
    match /families/{familyId}/incomes/{incomeId} {
      // Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Function to check if the user is the owner of the family
      function isOwner(familyId) {
        return isSignedIn() && request.auth.uid == familyId;
      }

      // Function to check if the user is the owner of the family and the resource exists
      function isExistingOwner(familyId) {
        return isOwner(familyId) && resource != null;
      }
      allow get: if isOwner(familyId);
      allow list: if isOwner(familyId);
      allow create: if isOwner(familyId) && request.resource.data.familyId == familyId;
      allow update: if isExistingOwner(familyId) && request.resource.data.familyId == resource.data.familyId;
      allow delete: if isExistingOwner(familyId);
    }

    /**
     * @description Manages access to expense records within a specific family.
     * @path /families/{familyId}/expenses/{expenseId}
     * @allow (create) User with auth UID 'user_abc' can create an expense document in family 'user_abc'.
     * @deny (create) User with auth UID 'user_xyz' cannot create an expense document in family 'user_abc'.
     * @allow (get) User with auth UID 'user_abc' can read an expense document in family 'user_abc'.
     * @deny (get) User with auth UID 'user_xyz' cannot read an expense document in family 'user_abc'.
     * @allow (update) User with auth UID 'user_abc' can update an expense document in family 'user_abc'.
     * @deny (update) User with auth UID 'user_xyz' cannot update an expense document in family 'user_abc'.
     * @allow (delete) User with auth UID 'user_abc' can delete an expense document in family 'user_abc'.
     * @deny (delete) User with auth UID 'user_xyz' cannot delete an expense document in family 'user_abc'.
     * @principle Enforces path-based ownership for expense records.
     */
    match /families/{familyId}/expenses/{expenseId} {
      // Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Function to check if the user is the owner of the family
      function isOwner(familyId) {
        return isSignedIn() && request.auth.uid == familyId;
      }

      // Function to check if the user is the owner of the family and the resource exists
      function isExistingOwner(familyId) {
        return isOwner(familyId) && resource != null;
      }

      allow get: if isOwner(familyId);
      allow list: if isOwner(familyId);
      allow create: if isOwner(familyId) && request.resource.data.familyId == familyId;
      allow update: if isExistingOwner(familyId) && request.resource.data.familyId == resource.data.familyId;
      allow delete: if isExistingOwner(familyId);
    }
    
    /**
     * @description Manages access to attendance sessions.
     * @path /attendanceSessions/{sessionId}
     * @principle Any authenticated user can read or write to any session.
     */
     match /attendanceSessions/{sessionId} {
      allow read, write: if request.auth != null;
    }
    
    /**
     * @description Manages access to monthly task lists.
     * @path /taskMonths/{monthId}
     * @principle Any authenticated user can read or write to any task list.
     */
    match /taskMonths/{monthId} {
       allow read, write: if request.auth != null;
    }

    /**
     * @description Manages access to the hour log for Ruma's job.
     * @path /hourLogs/{logId}
     * @principle Any authenticated user can read or write to any hour log entry.
     */
    match /hourLogs/{logId} {
      allow read, write: if request.auth != null;
    }

    /**
     * @description Manages access to refund tracking records.
     * @path /refunds/{refundId}
     * @principle Any authenticated user can read or write to any refund entry.
     */
    match /refunds/{refundId} {
      allow read, write: if request.auth != null;
    }
  }
}
